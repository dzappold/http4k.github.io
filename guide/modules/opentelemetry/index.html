



<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    
    <meta charset="utf-8">
<link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<meta http-equiv="x-ua-compatible" content="ie=edge">


<meta itemprop="name" content="http4k OpenTelemetry Modules">
<meta name="twitter:title" content="http4k OpenTelemetry Modules">
<meta property="og:title" content="http4k OpenTelemetry Modules" />



<meta name="description" content="Feature overview of the http4k-opentelemetry module">
<meta property="og:description" content="Feature overview of the http4k-opentelemetry module" />
<meta name="twitter:description" content="Feature overview of the http4k-opentelemetry module">



<link rel="canonical" href="https://www.http4k.org/guide/modules/opentelemetry/">



<meta name="author" content="David Denton (@daviddenton), Ivan Sanchez (@s4nchez)">
<meta name="twitter:creator" content="David Denton (@daviddenton), Ivan Sanchez (@s4nchez)">




<meta name="lang:clipboard.copy" content="en">

<meta name="lang:clipboard.copied" content="en">

<meta name="lang:search.language" content="en">

<meta name="lang:search.pipeline.stopwords" content="en">

<meta name="lang:search.pipeline.trimmer" content="en">

<meta name="lang:search.result.none" content="en">

<meta name="lang:search.result.one" content="en">

<meta name="lang:search.result.other" content="en">

<meta name="lang:search.tokenizer" content="en">

<!-- ****** faviconit.com favicons ****** -->
<link rel="shortcut icon" href="/img/favicon.ico">
<link rel="icon" sizes="16x16 32x32 64x64" href="/img/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/img/favicon-192.png">
<link rel="icon" type="image/png" sizes="160x160" href="/img/favicon-160.png">
<link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/img/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16.png">
<link rel="apple-touch-icon" href="/img/favicon-57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/img/favicon-114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/favicon-72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/favicon-144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/img/favicon-60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/img/favicon-120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/img/favicon-76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/img/favicon-152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicon-180.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/img/favicon-144.png">
<meta name="msapplication-config" content="/img/browserconfig.xml">
<!-- ****** faviconit.com favicons ****** -->
<meta name="generator" content="mkdocs-1.1.2, mkdocs-material-3.0.4">
    
    
    
    <title>http4k OpenTelemetry Modules</title>
    
    
    
    
    
    
    <meta name="theme-color" content="#3f51b5">
    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/codehilite.css"/>
    
    
    
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&amp;display=swap" rel="stylesheet"/>
    
    
    <link rel="stylesheet" href="/css/main.css"/>
    
    <link rel="stylesheet" href="../../../css/site.css">
    
    
</head>



<body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="blue">







<div class="intro">
    <div class="row no-gutters justify-content-center">
        <div class="aside col-auto">
    <img class="mb-3 sideToggle d-inline-block d-md-none" src="/img/exchange-icon.svg" width="20" alt="" srcset=""/>
    <a href="/">
        <div class="logo"><img src="/img/logo-intro.png" width="185" alt="logo" srcset=""/></div>
    </a>
    <ul class="nav flex-column">
        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../documentation/"
               title="Introduction">Introduction</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../quickstart/"
               title="Quickstart">Quickstart</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../rationale/"
               title="Rationale & concepts">Rationale & concepts</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../changelog/"
               title="Changelog">Changelog</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown active show">
            <a class="nav-link dropdown-toggle active"
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="true">Developer guide</a>
            <div class="dropdown-menu show">
            
            
            
    
        <a class="dropdown-item "
           href="../"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../core/"
           title="Core">Core</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../servers/"
           title="Server backend">Server backend</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../serverless/"
           title="Serverless backend">Serverless backend</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../clients/"
           title="HTTP & Websocket clients">HTTP & Websocket clients</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../contracts/"
           title="Typesafe contracts (OpenAPI3)">Typesafe contracts (OpenAPI3)</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../json/"
           title="JSON handling">JSON handling</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../templating/"
           title="Templating">Templating</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../multipart/"
           title="Multipart forms">Multipart forms</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../cloud_native/"
           title="Cloud Native Configuration">Cloud Native Configuration</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../cloud_events/"
           title="Cloud Events">Cloud Events</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../micrometer/"
           title="Micrometer">Micrometer</a>
    

            
            
            
    
        <a class="dropdown-item active"
           href="./"
           title="OpenTelemetry">OpenTelemetry</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../resilience4j/"
           title="Resilience4J">Resilience4J</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../aws/"
           title="AWS">AWS</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../oauth/"
           title="OAuth">OAuth</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../graphql/"
           title="GraphQL">GraphQL</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../jsonrpc/"
           title="JSON RPC">JSON RPC</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../xml/"
           title="XML handling">XML handling</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../yaml/"
           title="YAML handling">YAML handling</a>
    

            
            
            
    
        <a class="dropdown-item nav-link dropdown-toggle  "
            data-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="true"
            aria-expanded="false"> Testing</a>
        <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../testing/"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../hamkrest/"
           title="Hamkrest">Hamkrest</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../kotest/"
           title="Kotest">Kotest</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../webdriver/"
           title="WebDriver">WebDriver</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../approvaltests/"
           title="Approval Testing">Approval Testing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../chaos/"
           title="Chaos Testing">Chaos Testing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../servicevirtualisation/"
           title="Service Virtualisaion">Service Virtualisaion</a>
    

            
        </div>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown ">
            <a class="nav-link dropdown-toggle "
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="false">Cookbook</a>
            <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/"
           title="How to use this guide">How to use this guide</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/server_as_a_function/"
           title="Server as a function">Server as a function</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/client_as_a_function/"
           title="Client as a function">Client as a function</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/container_integration/"
           title="Container integration">Container integration</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/simple_routing/"
           title="Simple routing">Simple routing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/nestable_routes/"
           title="Nestable routes">Nestable routes</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/typesafe_http_contracts/"
           title="OpenAPI contracts/routing">OpenAPI contracts/routing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/using_templates/"
           title="Templating engines">Templating engines</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/request_context/"
           title="Typesafe RequestContexts">Typesafe RequestContexts</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/typesafe_http_requests_with_lenses/"
           title="Typesafe HTTP requests with lenses">Typesafe HTTP requests with lenses</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/custom_json_marshallers/"
           title="Custom JSON marshallers">Custom JSON marshallers</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/html_forms/"
           title="HTML forms">HTML forms</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/multipart_forms/"
           title="Multipart forms">Multipart forms</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/webjars/"
           title="WebJars">WebJars</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/websockets/"
           title="Websockets">Websockets</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/sse/"
           title="Server-Sent Events">Server-Sent Events</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/structured_logging_with_events/"
           title="Structured Logging with Events">Structured Logging with Events</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/basic_oauth_authorization_server/"
           title="Basic OAuth Server configuration">Basic OAuth Server configuration</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/custom_oauth_provider/"
           title="Custom OAuth Provider configuration">Custom OAuth Provider configuration</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/customised_servers/"
           title="Custom Server (SSL)">Custom Server (SSL)</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/service_virtualisation/"
           title="Service Virtualisation with Servirtium">Service Virtualisation with Servirtium</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/principal_lookup/"
           title="Principal lookup">Principal lookup</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/monitoring/"
           title="Monitoring http4k">Monitoring http4k</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/record_and_replay/"
           title="Recording/replaying HTTP traffic">Recording/replaying HTTP traffic</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../cookbook/test_driven_apps/"
           title="Test driven apps">Test driven apps</a>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../in_action/"
               title="http4k in action">http4k in action</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown ">
            <a class="nav-link dropdown-toggle "
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="false">Blog</a>
            <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/meet_http4k/"
           title="Meet http4k">Meet http4k</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/typesafe_websockets/"
           title="Typesafe Websockets">Typesafe Websockets</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/tdding_http4k/"
           title="TDDing http4k">TDDing http4k</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/typesafe_configuration/"
           title="Typesafe 12-factor config">Typesafe 12-factor config</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/documenting_apis_with_openapi/"
           title="Documenting http4k apps with OpenApi3">Documenting http4k apps with OpenApi3</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/retrospective_v3/"
           title="Retrospective on v3">Retrospective on v3</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/nanoservices/"
           title="Nanoservices">Nanoservices</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/toolbox/"
           title="Toolbox: Guns for show, knives for a pro">Toolbox: Guns for show, knives for a pro</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/http4k_v4/"
           title="http4k v4 - 17 platforms and counting...">http4k v4 - 17 platforms and counting...</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../../blog/regarding_jcenter/"
           title="JCenter Shutdown">JCenter Shutdown</a>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../performance/"
               title="Performance">Performance</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../faq/"
               title="FAQ">FAQ</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../support/"
               title="Getting support">Getting support</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../contributing/"
               title="Contribute/support http4k">Contribute/support http4k</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../code-of-conduct/"
               title="Code of Conduct">Code of Conduct</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../../api/"
               title="API docs">API docs</a>
        </li>
    

        
        <li class="nav-item">
            <a class="nav-link" href="https://github.com/http4k/http4k">
                <img src="/img/GitHub-Mark-black.png" width="28" alt="See source on GitHub">&nbsp;&nbsp;Source Code</a>
        </li>
    </ul>
</div>
        <main class="col">
            <div class="container">
                <div class="content">
                    <img class="mb-3 sideToggle" src="/img/exchange-icon.svg" width="20" alt="" srcset=""/>
                    
                    
                    <h1>OpenTelemetry</h1>
                    
                    <h3 id="installation_gradle">Installation (Gradle)<a class="headerlink" href="#installation_gradle" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">implementation</span> <span class="nl">group:</span> <span class="s2">&quot;org.http4k&quot;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s2">&quot;http4k-opentelemetry&quot;</span><span class="o">,</span> <span class="nl">version:</span> <span class="s2">&quot;4.9.0.1&quot;</span>
</code></pre></div>

<h3 id="about">About<a class="headerlink" href="#about" title="Permanent link">&para;</a></h3>
<p>This module provides configurable Filters to provide distributed tracing and metrics for http4k apps, plugging into the awesome <a href="https://opentelemetry.io/">OpenTelemetry</a> APIs.</p>
<p><code>OpenTelemetry is a collection of tools, APIs, and SDKs. You use it to instrument, generate, collect, and export telemetry data (metrics, logs, and traces) for analysis in order to understand your software's performance and behavior.</code></p>
<h3 id="tracing">Tracing <a href="https://github.com/http4k/http4k/blob/master/src/docs/guide/modules/opentelemetry/example_tracing.kt"><img class="octocat"/></a><a class="headerlink" href="#tracing" title="Permanent link">&para;</a></h3>
<p>OpenTelemetry provides a pluggable interface for tracing propagation, so you can easily switch between different implementations such as AWS X-Ray, B3 and Jaeger etc.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span> <span class="nn">guide.modules.opentelemetry</span>

<span class="k">import</span> <span class="nn">io.opentelemetry.context.propagation.ContextPropagators.create</span>
<span class="k">import</span> <span class="nn">io.opentelemetry.extension.aws.AwsXrayPropagator</span>
<span class="k">import</span> <span class="nn">io.opentelemetry.sdk.OpenTelemetrySdk</span>
<span class="k">import</span> <span class="nn">org.http4k.core.HttpHandler</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Method.POST</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Request</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Response</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Status.Companion.OK</span>
<span class="k">import</span> <span class="nn">org.http4k.core.then</span>
<span class="k">import</span> <span class="nn">org.http4k.filter.ClientFilters</span>
<span class="k">import</span> <span class="nn">org.http4k.filter.OpenTelemetryTracing</span>
<span class="k">import</span> <span class="nn">org.http4k.filter.ServerFilters</span>
<span class="k">import</span> <span class="nn">org.http4k.routing.bind</span>
<span class="k">import</span> <span class="nn">org.http4k.routing.path</span>
<span class="k">import</span> <span class="nn">org.http4k.routing.routes</span>

<span class="kd">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// configure OpenTelemetry using the Amazon XRAY tracing scheme</span>
    <span class="kd">val</span> <span class="nv">openTelemetry</span> <span class="o">=</span> <span class="n">OpenTelemetrySdk</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">setPropagators</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="n">AwsXrayPropagator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">()))</span>
        <span class="p">.</span><span class="na">buildAndRegisterGlobal</span><span class="p">()</span>

    <span class="c1">// this HttpHandler represents a 3rd party service, and will repeat the request body</span>
    <span class="kd">val</span> <span class="nv">repeater</span><span class="p">:</span> <span class="n">HttpHandler</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&quot;REMOTE REQUEST WITH TRACING HEADERS: </span><span class="si">$</span><span class="n">it</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">Response</span><span class="p">(</span><span class="n">OK</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">bodyString</span><span class="p">()</span> <span class="o">+</span> <span class="nb">it</span><span class="p">.</span><span class="na">bodyString</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="c1">// we will propagate the tracing headers using the tracer instance</span>
    <span class="kd">val</span> <span class="nv">repeaterClient</span> <span class="o">=</span> <span class="n">ClientFilters</span><span class="p">.</span><span class="na">OpenTelemetryTracing</span><span class="p">(</span><span class="n">openTelemetry</span><span class="p">).</span><span class="na">then</span><span class="p">(</span><span class="n">repeater</span><span class="p">)</span>

    <span class="c1">// this is the server app which will add tracing spans to incoming requests</span>
    <span class="kd">val</span> <span class="nv">app</span> <span class="o">=</span> <span class="n">ServerFilters</span><span class="p">.</span><span class="na">OpenTelemetryTracing</span><span class="p">(</span><span class="n">openTelemetry</span><span class="p">)</span>
        <span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">routes</span><span class="p">(</span><span class="s">&quot;/echo/{name}&quot;</span> <span class="n">bind</span> <span class="n">GET</span> <span class="n">to</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="nv">remoteResponse</span> <span class="o">=</span> <span class="n">repeaterClient</span><span class="p">(</span>
                <span class="n">Request</span><span class="p">(</span><span class="n">POST</span><span class="p">,</span> <span class="s">&quot;http://aRemoteServer/endpoint&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">!!</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">Response</span><span class="p">(</span><span class="n">OK</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">remoteResponse</span><span class="p">.</span><span class="na">bodyString</span><span class="p">())</span>
        <span class="p">}))</span>

    <span class="n">println</span><span class="p">(</span><span class="s">&quot;RETURNED TO CALLER: &quot;</span> <span class="o">+</span> <span class="n">app</span><span class="p">(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span> <span class="s">&quot;http://localhost:8080/echo/david&quot;</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="metrics">Metrics <a href="https://github.com/http4k/http4k/blob/master/src/docs/guide/modules/opentelemetry/example_metrics.kt"><img class="octocat"/></a><a class="headerlink" href="#metrics" title="Permanent link">&para;</a></h3>
<p>Both Server and Client filters are available for recording request counts and latency, optionally overriding values for the metric names, descriptions and request identification.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span> <span class="nn">guide.modules.opentelemetry</span>

<span class="k">import</span> <span class="nn">io.opentelemetry.api.metrics.GlobalMeterProvider</span>
<span class="k">import</span> <span class="nn">io.opentelemetry.exporters.inmemory.InMemoryMetricExporter</span>
<span class="k">import</span> <span class="nn">io.opentelemetry.sdk.metrics.SdkMeterProvider</span>
<span class="k">import</span> <span class="nn">io.opentelemetry.sdk.metrics.data.MetricData</span>
<span class="k">import</span> <span class="nn">org.http4k.client.ApacheClient</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Request</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Response</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Status.Companion.OK</span>
<span class="k">import</span> <span class="nn">org.http4k.core.then</span>
<span class="k">import</span> <span class="nn">org.http4k.filter.ClientFilters</span>
<span class="k">import</span> <span class="nn">org.http4k.filter.OpenTelemetryMetrics</span>
<span class="k">import</span> <span class="nn">org.http4k.filter.ServerFilters</span>
<span class="k">import</span> <span class="nn">org.http4k.routing.bind</span>
<span class="k">import</span> <span class="nn">org.http4k.routing.routes</span>

<span class="kd">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// test only: this sets up the metrics provider to something we can read</span>
    <span class="n">GlobalMeterProvider</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">SdkMeterProvider</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">buildAndRegisterGlobal</span><span class="p">())</span>

    <span class="kd">val</span> <span class="nv">server</span> <span class="o">=</span> <span class="n">routes</span><span class="p">(</span><span class="s">&quot;/metrics&quot;</span> <span class="n">bind</span> <span class="n">GET</span> <span class="n">to</span> <span class="p">{</span> <span class="n">Response</span><span class="p">(</span><span class="n">OK</span><span class="p">)</span> <span class="p">})</span>

    <span class="c1">// apply metrics filters to a server...</span>
    <span class="kd">val</span> <span class="nv">app</span> <span class="o">=</span> <span class="n">ServerFilters</span><span class="p">.</span><span class="na">OpenTelemetryMetrics</span><span class="p">.</span><span class="na">RequestCounter</span><span class="p">()</span>
        <span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">ServerFilters</span><span class="p">.</span><span class="na">OpenTelemetryMetrics</span><span class="p">.</span><span class="na">RequestTimer</span><span class="p">())</span>
        <span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>

    <span class="c1">// ... or to a client</span>
    <span class="kd">val</span> <span class="nv">client</span> <span class="o">=</span>
        <span class="n">ClientFilters</span><span class="p">.</span><span class="na">OpenTelemetryMetrics</span><span class="p">.</span><span class="na">RequestCounter</span><span class="p">()</span>
            <span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">ClientFilters</span><span class="p">.</span><span class="na">OpenTelemetryMetrics</span><span class="p">.</span><span class="na">RequestTimer</span><span class="p">())</span>
            <span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">ApacheClient</span><span class="p">())</span>

    <span class="c1">// make some calls</span>
    <span class="n">repeat</span><span class="p">(</span><span class="m">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">app</span><span class="p">(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span> <span class="s">&quot;/metrics&quot;</span><span class="p">))</span>
        <span class="n">client</span><span class="p">(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span> <span class="s">&quot;https://http4k.org&quot;</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// see some results</span>
    <span class="n">exportMetricsFromOpenTelemetry</span><span class="p">().</span><span class="na">forEach</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">&quot;metric: &quot;</span> <span class="o">+</span> <span class="nb">it</span><span class="p">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">&quot;, value: &quot;</span> <span class="o">+</span>
            <span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">longSumData</span><span class="p">.</span><span class="na">points</span><span class="p">.</span><span class="na">takeIf</span> <span class="p">{</span> <span class="nb">it</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">()</span> <span class="p">}</span> <span class="o">?:</span> <span class="nb">it</span><span class="p">.</span><span class="na">doubleSummaryData</span><span class="p">.</span><span class="na">points</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">fun</span> <span class="nf">exportMetricsFromOpenTelemetry</span><span class="p">():</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MetricData</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">InMemoryMetricExporter</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">apply</span> <span class="p">{</span>
    <span class="n">export</span><span class="p">((</span><span class="n">GlobalMeterProvider</span><span class="p">.</span><span class="na">get</span><span class="p">()</span> <span class="k">as</span> <span class="n">SdkMeterProvider</span><span class="p">).</span><span class="na">collectAllMetrics</span><span class="p">())</span>
<span class="p">}.</span><span class="na">finishedMetricItems</span>
</code></pre></div>
                    
                </div>
            </div>
        </main>
    </div>
</div>
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/index-min.js"></script>

      <script src="../../../assets/javascripts/application.583bbe55.js"></script>





<script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-125143867-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>


</body>
</html>