



<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    
    <meta charset="utf-8">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    
    <meta itemprop="name" content="http4k tutorials: Add typesafe 12-factor configuration to http4k apps with Environments.">
    <meta name="twitter:title" content="http4k tutorials: Add typesafe 12-factor configuration to http4k apps with Environments.">
    <meta property="og:title" content="http4k tutorials: Add typesafe 12-factor configuration to http4k apps with Environments." />
    

    
    <meta name="description" content="An overview of how to configure http4k applications using the http4k-cloudnative module">
    <meta property="og:description" content="An overview of how to configure http4k applications using the http4k-cloudnative module" />
    <meta name="twitter:description" content="An overview of how to configure http4k applications using the http4k-cloudnative module">
    

    
    <link rel="canonical" href="https://www.http4k.org/tutorials/typesafe_configuration/">
    

    
    <meta name="author" content="David Denton (@daviddenton), IvanSanchez (@s4nchez)">
    <meta name="twitter:creator" content="David Denton (@daviddenton), IvanSanchez (@s4nchez)">
    

    
    <meta name="lang:clipboard.copy" content="Copy to clipboard">
    
    <meta name="lang:clipboard.copied" content="Copied to clipboard">
    
    <meta name="lang:search.language" content="en">
    
    <meta name="lang:search.pipeline.stopwords" content="True">
    
    <meta name="lang:search.pipeline.trimmer" content="True">
    
    <meta name="lang:search.result.none" content="No matching documents">
    
    <meta name="lang:search.result.one" content="1 matching document">
    
    <meta name="lang:search.result.other" content="# matching documents">
    
    <meta name="lang:search.tokenizer" content="[\s\-]+">
    
    <!-- ****** faviconit.com favicons ****** -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="icon" sizes="16x16 32x32 64x64" href="/img/favicon.ico">
    <link rel="icon" type="image/png" sizes="196x196" href="/img/favicon-192.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/img/favicon-160.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/img/favicon-64.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16.png">
    <link rel="apple-touch-icon" href="/img/favicon-57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/favicon-114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/favicon-72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/favicon-144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/favicon-60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/favicon-120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon-76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/favicon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon-180.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="/img/favicon-144.png">
    <meta name="msapplication-config" content="/img/browserconfig.xml">
    <!-- ****** faviconit.com favicons ****** -->
    <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
    
    <title>http4k tutorials: Add typesafe 12-factor configuration to http4k apps with Environments.</title>
    
    
    
    <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
    
    <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
    
    
    
    
    <meta name="theme-color" content="#3f51b5">
    
    
    
    <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
    
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
    <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
    
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    <link rel="stylesheet" href="../../css/site.css">
    
    
</head>



<body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="blue">

<svg class="md-svg">
    <defs>
        
        
        <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
    </defs>
</svg>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>

<a href="../../#add-typesafe-12-factor-configuration-to-http4k-apps-with-environments" tabindex="1" class="md-skip">
    Skip to content
</a>


<header class="md-header" data-md-component="header">
    <nav class="md-header-nav md-grid">
        <div class="md-flex">
            <div class="md-flex__cell md-flex__cell--shrink">
                <a href="https://www.http4k.org/" title="http4k"
                   class="md-header-nav__button md-logo">
                    
                    <img src="../../img/logo_1100x200_white_on_blue_trans.png" height="24">
                    
                </a>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
                <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch">
                <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
                    
                    
                    
                    
                    http4k tutorials: Add typesafe 12-factor configuration to http4k apps with Environments.
                    
                </div>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
                
                
                <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
                
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
                
                
            </div>
            
            <div class="md-flex__cell md-flex__cell--shrink">
                <div class="md-header-nav__source">
                    


  


  <a href="https://github.com/http4k/http4k/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

                </div>
            </div>
            
        </div>
    </nav>
</header>

<div class="md-container">
    
    
    
    
    <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
            
            
            <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                    <div class="md-sidebar__inner">
                        <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.http4k.org/" title="http4k" class="md-nav__button md-logo">
      
        <img src="../../img/logo_1100x200_white_on_blue_trans.png" width="48" height="48">
      
    </a>
    http4k
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/http4k/http4k/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../rationale/" title="Rationale & Concepts" class="md-nav__link">
      Rationale & Concepts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../quickstart/" title="Getting started" class="md-nav__link">
      Getting started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Developer Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Developer Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/aws/" title="AWS" class="md-nav__link">
      AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/core/" title="Core" class="md-nav__link">
      Core
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/json/" title="JSON handling" class="md-nav__link">
      JSON handling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/clients/" title="HTTP & Websocket clients" class="md-nav__link">
      HTTP & Websocket clients
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/metrics/" title="Metrics" class="md-nav__link">
      Metrics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/multipart/" title="Multipart forms" class="md-nav__link">
      Multipart forms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/resilience/" title="Resilience" class="md-nav__link">
      Resilience
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/servers/" title="Server backend" class="md-nav__link">
      Server backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/serverless/" title="Serverless backend" class="md-nav__link">
      Serverless backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/templating/" title="Templating" class="md-nav__link">
      Templating
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/contracts/" title="Typesafe contracts (OpenAPI3)" class="md-nav__link">
      Typesafe contracts (OpenAPI3)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/oauth/" title="OAuth" class="md-nav__link">
      OAuth
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/cloud_native/" title="Cloud native Configuration" class="md-nav__link">
      Cloud native Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/jsonrpc/" title="JSON RPC" class="md-nav__link">
      JSON RPC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/xml/" title="XML handling" class="md-nav__link">
      XML handling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/hamkrest/" title="Hamkrest" class="md-nav__link">
      Hamkrest
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/approvaltests/" title="Approval Testing" class="md-nav__link">
      Approval Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/webdriver/" title="WebDriver" class="md-nav__link">
      WebDriver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/chaos/" title="Chaos Testing" class="md-nav__link">
      Chaos Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/modules/servicevirtualisation/" title="Service Virtualisaion" class="md-nav__link">
      Service Virtualisaion
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../guide/testing/" title="Application Testing" class="md-nav__link">
      Application Testing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tdding_http4k/" title="TDDing http4k" class="md-nav__link">
      TDDing http4k
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../documenting_apis_with_openapi/" title="Documenting http4k apps with OpenApi3" class="md-nav__link">
      Documenting http4k apps with OpenApi3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Cookbook
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Cookbook
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/server_as_a_function/" title="Server as a function" class="md-nav__link">
      Server as a function
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/client_as_a_function/" title="Client as a function" class="md-nav__link">
      Client as a function
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/container_integration/" title="Container integration" class="md-nav__link">
      Container integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/simple_routing/" title="Simple routing" class="md-nav__link">
      Simple routing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/service_virtualisation/" title="Service Virtualisation with Servirtium" class="md-nav__link">
      Service Virtualisation with Servirtium
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/nestable_routes/" title="Nestable routes" class="md-nav__link">
      Nestable routes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/using_templates/" title="Templating engines" class="md-nav__link">
      Templating engines
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/request_context/" title="Typesafe RequestContexts" class="md-nav__link">
      Typesafe RequestContexts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/typesafe_http_requests_with_lenses/" title="Typesafe HTTP requests with lenses" class="md-nav__link">
      Typesafe HTTP requests with lenses
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/custom_json_marshallers/" title="Custom JSON marshallers" class="md-nav__link">
      Custom JSON marshallers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/html_forms/" title="HTML forms" class="md-nav__link">
      HTML forms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/multipart_forms/" title="Multipart forms" class="md-nav__link">
      Multipart forms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/generating_data_classes/" title="Generating data classes for messages" class="md-nav__link">
      Generating data classes for messages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/websockets/" title="Websockets" class="md-nav__link">
      Websockets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/typesafe_http_contracts/" title="Typesafe HTTP contracts" class="md-nav__link">
      Typesafe HTTP contracts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/structured_logging_with_events/" title="Structured Logging with Events" class="md-nav__link">
      Structured Logging with Events
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/basic_oauth_authorization_server/" title="Basic OAuth Server configuration" class="md-nav__link">
      Basic OAuth Server configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/custom_oauth_provider/" title="Custom OAuth Provider configuration" class="md-nav__link">
      Custom OAuth Provider configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/principal_lookup/" title="Principal lookup" class="md-nav__link">
      Principal lookup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/monitoring/" title="Monitoring http4k" class="md-nav__link">
      Monitoring http4k
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/record_and_replay/" title="Recording/replaying HTTP traffic" class="md-nav__link">
      Recording/replaying HTTP traffic
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/test_driven_apps/" title="Test driven apps" class="md-nav__link">
      Test driven apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook/nanoservices/" title="Nanoservices" class="md-nav__link">
      Nanoservices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../performance/" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../in_action/" title="In action" class="md-nav__link">
      In action
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../blog/meet_http4k/" title="Meet http4k" class="md-nav__link">
      Meet http4k
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blog/typesafe_websockets/" title="Typesafe Websockets" class="md-nav__link">
      Typesafe Websockets
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../support/" title="Getting Support" class="md-nav__link">
      Getting Support
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contributing/" title="Contribute/Support http4k" class="md-nav__link">
      Contribute/Support http4k
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../api/" title="API docs" class="md-nav__link">
      API docs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
  </ul>
</nav>
                    </div>
                </div>
            </div>
            
            
            <div class="md-content">
                <article class="md-content__inner md-typeset">
                    
                    
                    <a href="https://github.com/http4k/http4k/edit/master/src/docs/tutorials/typesafe_configuration/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                    
                    
                    <h1 id="add-typesafe-12-factor-configuration-to-http4k-apps-with-environments">Add typesafe 12-factor configuration to http4k apps with Environments.</h1>
<h2 id="intro">Intro</h2>
<p>This post covers the various concerns around configuring HTTP apps, and introduces the <a href="https://http4k.org">http4k</a> 
approach for addressing these when deploying applications into cloud-native environments, which leverages the Kotlin type 
system for maximum safely and code reuse.</p>
<h2 id="concerns-when-configuring-applications">Concerns when configuring applications</h2>
<p>One of the tenets of operating applications according to the principles of <a href="https://12factor.net/">12factor</a>, 
and especially in containerised cloud-native apps, is to inject all app configuration through the use of environmental 
variables. Additionally, when using more restrictive settings (such as utilising JVM security manager policies or through 
the use of container images which don't provide an OS baseline) it may not be possible to read files (such as YAML, JSON 
etc) from disk, which reinforces this approach.</p>
<p>There are several particular relevant concerns that we need to address, but overall the effect that we are looking for is 
that any misconfiguration of the application will result in it failing to startup. For this reason we want to reify all 
values to check them as soon as possible in the application bootstrap phase.</p>
<h4 id="1-optionality">1. Optionality</h4>
<p>Kotlin's type system guards us against missing values being injected - for instance the following code will throw a 
<code>IllegalStateException</code> due to a typo in the parameter name:</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.pre</span>

<span class="c1">// export ANTIDISESTABLISHMENTARIANISM=opposition to the disestablishment of the Church of England</span>

<span class="k">val</span> <span class="py">definition</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;ANTIDISESTABLISHMENTARIAMISM&quot;</span><span class="p">)</span><span class="err">```</span>

<span class="n">However</span> <span class="n">not</span> <span class="n">all</span> <span class="n">configuration</span> <span class="n">values</span> <span class="n">will</span> <span class="n">be</span> <span class="n">required</span><span class="p">.</span> <span class="n">We</span> <span class="n">can</span> <span class="n">define</span> <span class="n">that</span> <span class="n">there</span> <span class="n">are</span> <span class="m">3</span> <span class="n">distinct</span> <span class="n">modes</span> <span class="n">of</span> <span class="n">optionality</span> 
<span class="n">available</span> <span class="k">for</span> <span class="n">each</span> <span class="n">parameter</span><span class="p">:</span>

<span class="p">-</span> <span class="p">**</span><span class="n">Required</span><span class="p">:**</span> <span class="n">These</span> <span class="n">values</span> <span class="n">must</span> <span class="n">be</span> <span class="n">injected</span> <span class="k">for</span> <span class="n">each</span> <span class="n">environment</span><span class="p">,</span> <span class="n">with</span> <span class="n">no</span> <span class="n">default</span> <span class="n">value</span> <span class="n">defined</span><span class="p">.</span> <span class="n">Most</span> <span class="n">configurations</span> <span class="n">such</span> 
<span class="k">as</span> <span class="n">hostnames</span> <span class="n">should</span> <span class="n">always</span> <span class="n">use</span> <span class="k">this</span> <span class="n">form</span> <span class="n">to</span> <span class="n">maximise</span> <span class="n">operational</span> <span class="n">safety</span><span class="p">.</span>
<span class="p">-</span> <span class="p">**</span><span class="n">Optional</span><span class="p">:**</span> <span class="n">These</span> <span class="n">values</span> <span class="n">can</span> <span class="n">be</span> <span class="n">supplied</span><span class="p">,</span> <span class="n">but</span> <span class="n">there</span> <span class="k">is</span> <span class="n">no</span> <span class="n">default</span> <span class="n">value</span><span class="p">.</span> <span class="n">This</span> <span class="n">category</span> <span class="n">fits</span> <span class="n">well</span> <span class="n">with</span> <span class="k">dynamic</span> <span class="n">properties</span> 
<span class="n">which</span> <span class="n">could</span> <span class="n">be</span> <span class="k">data</span><span class="p">-</span><span class="n">driven</span> <span class="p">(</span><span class="n">ie</span><span class="p">.</span> <span class="n">not</span> <span class="n">known</span> <span class="n">at</span> <span class="n">compile</span><span class="p">-</span><span class="n">time</span><span class="p">).</span>
<span class="p">-</span> <span class="p">**</span><span class="n">Defaulted</span><span class="p">:**</span> <span class="n">These</span> <span class="n">values</span> <span class="n">can</span> <span class="n">be</span> <span class="n">supplied</span><span class="p">,</span> <span class="n">but</span> <span class="n">a</span> <span class="n">fallback</span> <span class="n">value</span> <span class="p">(</span><span class="n">or</span> <span class="n">chain</span> <span class="n">of</span> <span class="n">other</span> <span class="n">config</span> <span class="n">values</span><span class="p">)</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="k">if</span> <span class="n">they</span> 
<span class="n">are</span> <span class="n">not</span><span class="p">.</span>

<span class="n">Missing</span> <span class="n">values</span> <span class="n">should</span> <span class="n">produce</span> <span class="n">a</span> <span class="n">reasonable</span> <span class="n">error</span> <span class="n">and</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">app</span> <span class="n">from</span> <span class="n">starting</span><span class="p">.</span>

<span class="err">####</span> <span class="m">2.</span> <span class="n">Type</span> <span class="n">coercion</span>
<span class="n">Most</span> <span class="n">applications</span> <span class="n">will</span> <span class="n">require</span> <span class="n">a</span> <span class="n">variety</span> <span class="n">of</span> <span class="n">configuration</span> <span class="n">primitive</span> <span class="n">types</span><span class="p">,</span> <span class="n">which</span> <span class="n">may</span> <span class="n">or</span> <span class="n">may</span> <span class="n">not</span> <span class="n">map</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Java</span><span class="p">/</span><span class="n">Kotlin</span> 
<span class="n">standard</span> <span class="n">types</span><span class="p">,</span> <span class="n">including</span><span class="p">:</span>

<span class="p">-</span> <span class="p">**</span><span class="n">strings</span><span class="p">**</span> <span class="n">such</span> <span class="k">as</span> <span class="n">service</span> <span class="n">URLs</span><span class="p">,</span> <span class="n">log</span> <span class="n">levels</span><span class="p">,</span> <span class="n">or</span> <span class="n">AWS</span> <span class="n">role</span> <span class="n">names</span>
<span class="p">-</span> <span class="p">**</span><span class="n">numeric</span><span class="p">**</span> <span class="n">values</span> <span class="n">such</span> <span class="k">as</span> <span class="n">ports</span> <span class="n">or</span> <span class="n">retry</span> <span class="n">counts</span>
<span class="p">-</span> <span class="p">**</span><span class="n">booleans</span><span class="p">**</span> <span class="n">such</span> <span class="k">as</span> <span class="n">debug</span> <span class="n">switch</span> <span class="n">or</span> <span class="n">feature</span> <span class="n">flags</span>
<span class="p">-</span> <span class="p">**</span><span class="n">duration</span><span class="p">**</span> <span class="n">values</span> <span class="k">for</span> <span class="n">timeouts</span><span class="p">,</span> <span class="n">backoff</span> <span class="n">times</span>

<span class="n">But</span> <span class="n">handling</span> <span class="n">these</span> <span class="n">raw</span> <span class="n">types</span> <span class="n">alone</span> <span class="k">is</span> <span class="n">not</span> <span class="n">enough</span> <span class="n">to</span> <span class="n">guarantee</span> <span class="n">safety</span> <span class="p">-</span> <span class="n">it</span> <span class="k">is</span> <span class="n">best</span> <span class="n">to</span> <span class="n">marshall</span> <span class="n">the</span> <span class="n">values</span> <span class="n">into</span> <span class="n">a</span> 
<span class="n">suitable</span> <span class="n">operational</span><span class="p">/</span><span class="n">domain</span> <span class="n">type</span> <span class="n">that</span> <span class="n">can</span> <span class="n">validate</span> <span class="n">the</span> <span class="n">input</span> <span class="n">and</span> <span class="n">avoid</span> <span class="n">confusion</span><span class="p">.</span> <span class="n">Kotlin</span> <span class="n">gives</span> <span class="n">us</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">way</span> <span class="n">to</span> <span class="k">do</span> <span class="k">this</span> 
<span class="n">using</span> <span class="n">`require`</span> <span class="k">as</span> <span class="n">a</span> <span class="n">guard</span><span class="p">:</span>

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.pre</span>

<span class="k">class</span> <span class="nc">Port</span><span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">((</span><span class="m">1.</span><span class="p">.</span><span class="m">65535</span><span class="p">).</span><span class="n">contains</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span> <span class="s">&quot;Out of range Port: &#39;$value&#39;&quot;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// export PORT=8000</span>
<span class="k">val</span> <span class="py">port</span> <span class="p">=</span> <span class="n">Port</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;PORT&quot;</span><span class="p">).</span><span class="n">toInt</span><span class="p">())</span><span class="err">```</span>

<span class="n">Additionally</span> <span class="n">to</span> <span class="n">the</span> <span class="n">above</span><span class="p">,</span> <span class="n">it</span> <span class="k">is</span> <span class="n">important</span> <span class="n">to</span> <span class="n">represent</span> <span class="n">those</span> <span class="n">values</span> <span class="k">in</span> <span class="n">a</span> <span class="n">form</span> <span class="n">that</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">misinterpreted</span><span class="p">.</span> <span class="n">A</span> <span class="n">good</span> 
<span class="n">example</span> <span class="n">of</span> <span class="k">this</span> <span class="k">is</span> <span class="n">the</span> <span class="n">passing</span> <span class="n">of</span> <span class="n">temporal</span> <span class="n">values</span> <span class="k">as</span> <span class="n">integers</span> <span class="p">-</span> <span class="n">timeouts</span> <span class="n">defined</span> <span class="k">this</span> <span class="n">way</span> <span class="n">could</span> <span class="n">be</span> <span class="n">easily</span> <span class="n">be</span> 
<span class="n">parsed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">wrong</span> <span class="n">time</span> <span class="n">unit</span> <span class="p">(</span><span class="n">seconds</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">milliseconds</span><span class="p">).</span> <span class="n">Using</span> <span class="n">a</span> <span class="n">higher</span> <span class="n">level</span> <span class="n">primitive</span> <span class="n">such</span> <span class="k">as</span> <span class="n">`Duration`</span> 
<span class="n">will</span> <span class="n">help</span> <span class="n">us</span> <span class="n">here</span><span class="p">:</span>

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.pre</span>

<span class="k">import</span> <span class="nn">java.time.Duration</span>

<span class="k">data</span> <span class="k">class</span> <span class="nc">Timeout</span><span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">Duration</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(!</span><span class="n">value</span><span class="p">.</span><span class="n">isNegative</span><span class="p">)</span> <span class="p">{</span> <span class="s">&quot;Cannot have negative timeout&quot;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// export TIMEOUT=PT30S</span>
<span class="k">val</span> <span class="py">timeout</span> <span class="p">=</span> <span class="n">Timeout</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;TIMEOUT&quot;</span><span class="p">)))</span><span class="err">```</span>

<span class="n">Obviously</span><span class="p">,</span> <span class="n">the</span> <span class="n">above</span> <span class="k">is</span> <span class="n">still</span> <span class="n">not</span> <span class="n">very</span> <span class="n">safe</span> <span class="p">-</span> <span class="n">and</span> <span class="n">what</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">more</span><span class="p">,</span> <span class="n">a</span> <span class="n">coercion</span> <span class="n">could</span> <span class="n">now</span> <span class="n">fail</span> <span class="n">with</span> <span class="n">one</span> <span class="n">of</span> <span class="m">3</span> <span class="n">different</span> 
<span class="n">exceptions</span> <span class="n">depending</span> <span class="n">on</span> <span class="k">if</span> <span class="n">the</span> <span class="n">value</span> <span class="n">was</span> <span class="n">missing</span> <span class="p">(</span><span class="n">`IllegalStateException`</span><span class="p">),</span> <span class="n">unparsable</span> <span class="p">(</span><span class="n">`DateTimeParseException`</span><span class="p">)</span> <span class="n">or</span> 
<span class="n">invalid</span> <span class="p">(</span><span class="n">`IllegalArgumentException`</span><span class="p">).</span> <span class="n">The</span> <span class="n">conversion</span> <span class="n">code</span> <span class="n">from</span> <span class="err">`</span><span class="n">String</span> <span class="p">-&gt;</span> <span class="n">Duration</span><span class="err">`</span> <span class="n">must</span> <span class="n">also</span> <span class="n">be</span> <span class="n">repeated</span> <span class="p">(</span><span class="n">or</span> <span class="n">extracted</span><span class="p">)</span> 
<span class="k">for</span> <span class="n">each</span> <span class="n">value</span> <span class="n">that</span> <span class="n">we</span> <span class="n">wish</span> <span class="n">to</span> <span class="n">parse</span><span class="p">.</span>

<span class="err">####</span> <span class="m">3.</span> <span class="n">Multiplicity</span>
<span class="n">Configuration</span> <span class="n">parameters</span> <span class="n">may</span> <span class="n">have</span> <span class="n">one</span> <span class="n">or</span> <span class="n">many</span> <span class="n">values</span> <span class="n">and</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">converted</span> <span class="n">safely</span> <span class="n">from</span> <span class="n">the</span> <span class="n">injected</span> <span class="n">string</span> 
<span class="n">representation</span> <span class="p">(</span><span class="n">usually</span> <span class="n">comma</span><span class="p">-</span><span class="n">separated</span><span class="p">)</span> <span class="n">and</span> <span class="n">into</span> <span class="n">their</span> <span class="n">internally</span> <span class="n">represented</span> <span class="n">types</span> <span class="n">at</span> <span class="n">application</span> <span class="n">startup</span><span class="p">:</span> 

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.pre</span>

<span class="k">class</span> <span class="nc">Host</span><span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="c1">// export HOSTNAMES=eu-west1.aws.com,eu-west2.aws.com,eu-west3.aws.com</span>

<span class="k">val</span> <span class="py">hosts</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOSTNAMES&quot;</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">).</span><span class="n">map</span> <span class="p">{</span> <span class="n">Host</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">trim</span><span class="p">())</span> <span class="p">}</span><span class="err">```</span>

<span class="n">Once</span> <span class="n">again</span><span class="p">,</span> <span class="n">the</span> <span class="n">splitting</span> <span class="n">code</span> <span class="n">will</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">repeated</span> <span class="k">for</span> <span class="n">each</span> <span class="n">config</span> <span class="n">value</span><span class="p">,</span> <span class="n">or</span> <span class="n">extracted</span> <span class="n">to</span> <span class="n">a</span> <span class="n">library</span> <span class="n">function</span><span class="p">.</span>

<span class="err">####</span> <span class="m">4.</span> <span class="n">Security</span>
<span class="n">The</span> <span class="n">configuration</span> <span class="n">of</span> <span class="n">a</span> <span class="n">standard</span> <span class="n">app</span> <span class="n">will</span> <span class="n">generally</span> <span class="n">contain</span> <span class="n">both</span> <span class="n">sensitive</span> <span class="n">and</span> <span class="n">non</span><span class="p">-</span><span class="n">sensitive</span> <span class="n">values</span><span class="p">.</span> <span class="n">Sensitive</span> <span class="n">such</span> <span class="k">as</span> 
<span class="n">application</span> <span class="n">secrets</span><span class="p">,</span> <span class="n">DB</span> <span class="n">passwords</span> <span class="n">or</span> <span class="n">API</span> <span class="n">keys</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="k">in</span> <span class="n">a</span> <span class="n">way</span> <span class="n">that</span> <span class="n">avoid</span> <span class="n">storing</span> <span class="n">directly</span> <span class="k">in</span> <span class="n">memory</span> <span class="k">in</span> <span class="n">a</span> 
<span class="n">readable</span> <span class="n">format</span> <span class="n">or</span> <span class="n">long</span> <span class="n">lived</span> <span class="n">fashion</span><span class="p">,</span> <span class="k">where</span> <span class="n">they</span> <span class="n">may</span> <span class="n">be</span> <span class="n">inadvertently</span> <span class="n">inspected</span> <span class="n">or</span> <span class="n">outputted</span> <span class="n">into</span> <span class="n">a</span> <span class="n">log</span> <span class="n">file</span><span class="p">.</span>

<span class="n">Dangling</span> <span class="n">code</span> <span class="n">situations</span> <span class="n">such</span> <span class="k">as</span> <span class="k">in</span> <span class="n">the</span> <span class="n">code</span> <span class="n">below</span> <span class="n">are</span> <span class="n">common</span><span class="p">,</span> <span class="n">and</span> <span class="n">are</span> <span class="n">asking</span> <span class="k">for</span> <span class="n">trouble</span><span class="p">...</span>

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.pre</span>

<span class="k">import</span> <span class="nn">org.http4k.client.OkHttp</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Request</span>
<span class="k">import</span> <span class="nn">java.nio.ByteBuffer</span>

<span class="k">val</span> <span class="py">s3</span> <span class="p">=</span> <span class="n">OkHttp</span><span class="p">()</span>

<span class="k">fun</span> <span class="nf">readFile</span><span class="p">(</span><span class="n">secretKey</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">bucketKey</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">ByteBuffer</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">s3</span><span class="p">(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span> <span class="s">&quot;https://mybucket.s3.amazonaws.com/$bucketKey&quot;</span><span class="p">)).</span><span class="n">body</span><span class="p">.</span><span class="n">payload</span>
<span class="p">}</span>

<span class="c1">// export AWS_SECRET_KEY=someSuperSecretValueThatOpsReallyDoNotWantYouToKnow</span>

<span class="k">val</span> <span class="py">file</span> <span class="p">=</span> <span class="n">readFile</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;AWS_SECRET_KEY&quot;</span><span class="p">),</span> <span class="s">&quot;myfile.txt&quot;</span><span class="p">)</span><span class="err">```</span>

<span class="err">####</span> <span class="m">5.</span> <span class="n">Configuration</span> <span class="n">Context</span> <span class="p">&amp;</span> <span class="n">Overriding</span>
<span class="n">We</span> <span class="n">also</span> <span class="n">want</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">defining</span> <span class="n">all</span> <span class="n">values</span> <span class="k">for</span> <span class="n">all</span> <span class="n">possible</span> <span class="n">scenarios</span> <span class="p">-</span> <span class="k">for</span> <span class="n">example</span> <span class="k">in</span> <span class="n">test</span> <span class="n">cases</span><span class="p">,</span> <span class="n">so</span> <span class="n">the</span> <span class="n">ability</span> 
<span class="n">to</span> <span class="n">overlay</span> <span class="n">configuration</span> <span class="n">sets</span> <span class="n">on</span> <span class="n">top</span> <span class="n">of</span> <span class="n">each</span> <span class="n">other</span> <span class="k">is</span> <span class="n">useful</span><span class="p">.</span> <span class="n">Although</span> <span class="n">it</span> <span class="k">is</span> <span class="n">against</span> <span class="n">the</span> <span class="n">rules</span> <span class="n">of</span> <span class="m">12</span><span class="p">-</span><span class="n">factor</span><span class="p">,</span> <span class="n">it</span> <span class="k">is</span> <span class="n">sometimes</span> 
<span class="n">convenient</span> <span class="n">to</span> <span class="n">source</span> <span class="n">parameter</span> <span class="n">values</span> <span class="n">from</span> <span class="n">a</span> <span class="n">variety</span> <span class="n">of</span> <span class="n">contexts</span> <span class="k">when</span> <span class="n">running</span> <span class="n">applications</span> <span class="k">in</span> <span class="n">non</span><span class="p">-</span><span class="n">cloud</span> <span class="n">environments</span><span class="p">:</span>

<span class="p">-</span> <span class="n">System</span> <span class="n">Environment</span> <span class="n">variables</span>
<span class="p">-</span> <span class="n">Properties</span> <span class="n">files</span>
<span class="p">-</span> <span class="n">JAR</span> <span class="n">resources</span>
<span class="p">-</span> <span class="n">Local</span> <span class="n">files</span>
<span class="p">-</span> <span class="n">Source</span> <span class="n">code</span> <span class="n">defined</span> <span class="n">environmental</span> <span class="n">configuration</span>

<span class="n">Implementing</span> <span class="k">this</span> <span class="n">kind</span> <span class="n">of</span> <span class="n">fallback</span> <span class="n">logic</span> <span class="n">manually</span><span class="p">,</span> <span class="n">you</span><span class="err">&#39;</span><span class="n">d</span> <span class="n">end</span> <span class="n">up</span> <span class="n">with</span> <span class="n">code</span> <span class="n">like</span> <span class="n">the</span> <span class="n">below</span><span class="p">:</span> 
<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.pre</span>

<span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&quot;USERNAME&quot;</span><span class="p">)</span> <span class="o">?:</span> <span class="n">System</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;USERNAME&quot;</span><span class="p">)</span> <span class="o">?:</span> <span class="s">&quot;DEFAULT_USER&quot;</span><span class="err">```</span>

<span class="err">##</span> <span class="n">The</span> <span class="n">http4k</span> <span class="n">approach</span><span class="p">...</span>
<span class="n">There</span> <span class="n">are</span> <span class="p">[</span><span class="n">already</span><span class="p">][</span><span class="n">properlty</span><span class="p">]</span> <span class="p">[</span><span class="n">many</span><span class="p">][</span><span class="n">config4k</span><span class="p">]</span> <span class="p">[</span><span class="n">options</span><span class="p">][</span><span class="n">konf</span><span class="p">]</span> <span class="p">[</span><span class="k">for</span><span class="p">][</span><span class="n">cfg4k</span><span class="p">]</span> <span class="p">[</span><span class="n">configurational</span><span class="p">][</span><span class="n">configur8</span><span class="p">]</span> 
<span class="na">[libraries]</span><span class="p">[</span><span class="n">kaconf</span><span class="p">]</span> <span class="n">written</span> <span class="k">in</span> <span class="n">Kotlin</span><span class="p">,</span> <span class="n">but</span> <span class="p">[</span><span class="n">http4k</span><span class="p">]</span> <span class="n">also</span> <span class="n">provides</span> <span class="n">an</span> <span class="n">option</span> <span class="k">in</span> <span class="n">the</span> <span class="n">`http4k-cloudnative`</span> <span class="n">add</span><span class="p">-</span><span class="n">on</span> <span class="n">module</span> 
<span class="n">which</span> <span class="n">leverages</span> <span class="n">the</span> <span class="n">power</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Lens</span> <span class="n">system</span> <span class="n">already</span> <span class="n">built</span> <span class="n">into</span> <span class="n">the</span> <span class="n">core</span> <span class="n">library</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">a</span> <span class="n">consistent</span> <span class="n">experience</span> <span class="n">to</span> 
<span class="n">API</span> <span class="n">users</span><span class="p">.</span> <span class="n">In</span> <span class="n">case</span> <span class="n">you</span><span class="err">&#39;</span><span class="n">re</span> <span class="n">new</span> <span class="n">to</span> <span class="n">Lenses</span><span class="p">,</span> <span class="n">here</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">a</span> <span class="n">recap</span><span class="p">...</span>

<span class="err">###</span> <span class="n">Lenses</span> <span class="p">-</span> <span class="n">a</span> <span class="n">recap</span>
<span class="n">In</span> <span class="p">[</span><span class="n">http4k</span><span class="p">],</span> <span class="n">Lenses</span> <span class="n">are</span> <span class="n">typically</span> <span class="n">used</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">typesafe</span> <span class="n">conversion</span> <span class="n">of</span> <span class="n">typed</span> <span class="n">values</span> <span class="n">into</span> <span class="n">and</span> <span class="k">out</span> <span class="n">of</span> <span class="n">HTTP</span> <span class="n">messages</span><span class="p">,</span> 
<span class="n">although</span> <span class="k">this</span> <span class="n">concept</span> <span class="n">has</span> <span class="n">been</span> <span class="n">extended</span> <span class="n">within</span> <span class="n">the</span> <span class="p">[</span><span class="n">http4k</span><span class="p">]</span> <span class="n">ecosystem</span> <span class="n">to</span> <span class="n">support</span> <span class="n">that</span> <span class="n">of</span> <span class="n">a</span> <span class="n">form</span> <span class="n">handling</span> <span class="n">and</span> <span class="n">request</span> 
<span class="n">contexts</span><span class="p">.</span>

<span class="n">A</span> <span class="n">Lens</span> <span class="k">is</span> <span class="n">an</span> <span class="n">stateless</span> <span class="k">object</span> <span class="nc">responsible</span> <span class="k">for</span> <span class="n">either</span> <span class="n">the</span> <span class="n">one</span><span class="p">-</span><span class="n">way</span> <span class="p">(</span><span class="n">or</span> <span class="n">Bidirectional</span><span class="p">)</span> <span class="n">transformation</span> <span class="n">of</span>

<span class="n">It</span> <span class="n">defines</span> <span class="n">type</span> <span class="n">parameters</span> <span class="n">representing</span> <span class="n">input</span> <span class="n">`IN`</span> <span class="n">and</span> <span class="n">output</span> <span class="n">`OUT`</span> <span class="n">types</span> <span class="n">and</span> <span class="n">implements</span> 
<span class="n">one</span> <span class="p">(</span><span class="k">for</span> <span class="n">a</span> <span class="n">`Lens`</span><span class="p">)</span> <span class="n">or</span> <span class="n">both</span> <span class="p">(</span><span class="k">for</span> <span class="n">a</span> <span class="n">`BiDiLens`</span><span class="p">)</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span> <span class="n">interfaces</span><span class="p">:</span>

<span class="m">1.</span> <span class="p">**</span><span class="n">LensExtractor</span><span class="p">**</span> <span class="p">-</span> <span class="n">takes</span> <span class="n">a</span> <span class="n">value</span> <span class="n">of</span> <span class="n">type</span> <span class="n">`IN`</span> <span class="n">and</span> <span class="n">extracts</span> <span class="n">a</span> <span class="n">value</span> <span class="n">of</span> <span class="n">type</span> <span class="n">`OUT`</span>
<span class="m">2.</span> <span class="p">**</span><span class="n">LensInjector</span><span class="p">**</span> <span class="p">-</span> <span class="n">takes</span> <span class="n">a</span> <span class="n">value</span> <span class="n">of</span> <span class="n">type</span> <span class="n">`IN`</span> <span class="n">and</span> <span class="n">a</span> <span class="n">value</span> <span class="n">of</span> <span class="n">type</span> <span class="n">`OUT`</span> <span class="n">and</span> <span class="n">returns</span> <span class="n">a</span> <span class="n">modified</span> <span class="n">value</span> <span class="n">of</span> <span class="n">type</span> <span class="n">`IN`</span> 
<span class="n">with</span> <span class="n">the</span> <span class="n">value</span> <span class="n">injected</span> <span class="n">into</span> <span class="n">it</span><span class="p">.</span>

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.post</span>

<span class="k">interface</span> <span class="nc">LensExtractor</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">IN</span><span class="p">,</span> <span class="k">out</span> <span class="n">OUT</span><span class="p">&gt;</span> <span class="p">:</span> <span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">OUT</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="n">IN</span><span class="p">):</span> <span class="n">OUT</span>
<span class="p">}</span>

<span class="k">interface</span> <span class="nc">LensInjector</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">IN</span><span class="p">,</span> <span class="k">in</span> <span class="n">OUT</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">operator</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="n">R</span> <span class="p">:</span> <span class="n">OUT</span><span class="p">&gt;</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">IN</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">R</span><span class="p">):</span> <span class="n">R</span>
<span class="p">}</span>

<span class="k">interface</span> <span class="nc">Lens</span><span class="p">&lt;</span><span class="n">IN</span><span class="p">,</span> <span class="n">OUT</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">LensExtractor</span><span class="p">&lt;</span><span class="n">IN</span><span class="p">,</span> <span class="n">OUT</span><span class="p">&gt;</span>

<span class="k">interface</span> <span class="nc">BiDiLens</span><span class="p">&lt;</span><span class="n">IN</span><span class="p">,</span> <span class="n">OUT</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">Lens</span><span class="p">&lt;</span><span class="n">IN</span><span class="p">,</span> <span class="n">OUT</span><span class="p">&gt;,</span> <span class="n">LensInjector</span><span class="p">&lt;</span><span class="n">IN</span><span class="p">,</span> <span class="n">OUT</span><span class="p">&gt;</span><span class="err">```</span>

<span class="n">The</span> <span class="n">creation</span> <span class="n">of</span> <span class="n">a</span> <span class="n">Lens</span> <span class="n">consists</span> <span class="n">of</span> <span class="m">4</span> <span class="n">main</span> <span class="n">concerns</span><span class="p">:</span>

<span class="m">1.</span> <span class="p">**</span><span class="n">targeting</span><span class="p">**</span> <span class="n">determines</span> <span class="k">where</span> <span class="n">the</span> <span class="n">Lens</span> <span class="n">expects</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">and</span> <span class="n">inject</span> <span class="n">the</span> <span class="n">values</span> <span class="n">from</span><span class="p">/</span><span class="n">to</span><span class="p">,</span> <span class="n">which</span> <span class="n">can</span> <span class="n">consist</span> <span class="n">of</span> <span class="n">both</span> 
<span class="n">an</span> <span class="n">overall</span> <span class="n">target</span> <span class="n">and</span> <span class="n">a</span> <span class="n">name</span> <span class="n">within</span> <span class="n">that</span> <span class="n">target</span><span class="p">.</span>
<span class="m">2.</span> <span class="p">**</span><span class="n">multiplicity</span><span class="p">**</span> <span class="n">handling</span> <span class="n">which</span> <span class="n">defines</span> <span class="n">how</span> <span class="n">many</span> <span class="n">of</span> <span class="n">a</span> <span class="n">particular</span> <span class="n">value</span> <span class="n">we</span> <span class="n">are</span> <span class="n">attempting</span> <span class="n">to</span> <span class="n">handle</span><span class="p">.</span>
<span class="m">3.</span> <span class="n">the</span> <span class="p">**</span><span class="n">transformation</span><span class="p">**</span> <span class="n">chain</span> <span class="n">of</span> <span class="n">function</span> <span class="n">composition</span> <span class="n">which</span> <span class="n">forms</span> <span class="n">a</span> <span class="n">specification</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">one</span> <span class="n">type</span> <span class="n">to</span> <span class="n">another</span><span class="p">.</span> 
<span class="n">This</span> <span class="k">is</span> <span class="n">done</span> <span class="k">in</span> <span class="n">code</span> <span class="n">using</span> <span class="n">the</span> <span class="err">`</span><span class="n">map</span><span class="p">()</span><span class="err">`</span> <span class="n">method</span> <span class="n">defined</span> <span class="n">on</span> <span class="n">the</span> <span class="n">Lens</span><span class="p">.</span>
<span class="m">4.</span> <span class="n">the</span> <span class="p">**</span><span class="n">optionality</span><span class="p">**</span> <span class="n">of</span> <span class="n">a</span> <span class="n">Lens</span> <span class="n">denotes</span> <span class="n">the</span> <span class="n">behaviour</span> <span class="k">if</span><span class="p">/</span><span class="k">when</span> <span class="n">a</span> <span class="n">value</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">found</span> <span class="k">in</span> <span class="n">the</span> <span class="n">target</span><span class="p">.</span>

<span class="n">To</span> <span class="n">define</span> <span class="n">a</span> <span class="n">Lens</span> <span class="n">instance</span> <span class="n">through</span> <span class="n">the</span> <span class="p">[</span><span class="n">http4k</span><span class="p">]</span> <span class="n">Lens</span> <span class="n">API</span><span class="p">,</span> <span class="n">we</span> <span class="n">take</span> <span class="n">an</span> <span class="n">initial</span> <span class="p">**</span><span class="n">target</span><span class="p">**</span> <span class="n">specification</span><span class="p">,</span> <span class="n">decide</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> 
<span class="p">**</span><span class="n">multiplicity</span><span class="p">**,</span> <span class="n">provide</span> <span class="n">any</span> <span class="p">**</span><span class="n">transformations</span><span class="p">**</span> <span class="n">with</span> <span class="err">`</span><span class="n">map</span><span class="p">()</span><span class="err">`</span><span class="p">,</span> <span class="n">and</span> <span class="k">finally</span> <span class="n">reify</span> <span class="n">the</span> <span class="n">specification</span> <span class="n">into</span> <span class="n">a</span> <span class="n">Lens</span> <span class="n">instance</span> 
<span class="k">by</span> <span class="n">deciding</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">optionality</span><span class="p">.</span>

<span class="n">It</span> <span class="n">sounds</span> <span class="n">involved</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="k">is</span> <span class="n">consistent</span> <span class="n">and</span> <span class="n">the</span> <span class="n">fluent</span> <span class="n">API</span> <span class="n">has</span> <span class="n">been</span> <span class="n">designed</span> <span class="n">to</span> <span class="n">make</span> <span class="n">it</span> <span class="n">simpler</span><span class="p">.</span> <span class="n">By</span> <span class="n">way</span> <span class="n">of</span> <span class="n">an</span> <span class="n">example</span><span class="p">,</span> 
<span class="n">here</span> <span class="n">we</span> <span class="n">define</span> <span class="n">a</span> <span class="n">bi</span><span class="p">-</span><span class="n">directional</span> <span class="n">Lens</span> <span class="k">for</span> <span class="n">custom</span> <span class="n">type</span> <span class="n">`Page`</span><span class="p">,</span> <span class="n">extracted</span> <span class="n">from</span> <span class="n">a</span> <span class="n">querystring</span> <span class="n">value</span> <span class="n">and</span> <span class="n">defaulting</span> <span class="n">to</span> <span class="n">Page</span> <span class="m">1.</span>

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.post</span>

<span class="k">import</span> <span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span> <span class="nn">org.http4k.core.Request</span>
<span class="k">import</span> <span class="nn">org.http4k.lens.BiDiLens</span>
<span class="k">import</span> <span class="nn">org.http4k.lens.Query</span>
<span class="k">import</span> <span class="nn">org.http4k.lens.int</span>

<span class="k">data</span> <span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="n">value</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="s">&quot;Page number must be positive&quot;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">val</span> <span class="py">lens</span><span class="p">:</span> <span class="n">BiDiLens</span><span class="p">&lt;</span><span class="n">Request</span><span class="p">,</span> <span class="n">Page</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Query</span><span class="p">.</span><span class="n">int</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">::</span><span class="n">Page</span><span class="p">,</span> <span class="n">Page</span><span class="o">::</span><span class="n">value</span><span class="p">).</span><span class="n">defaulted</span><span class="p">(</span><span class="s">&quot;pageNumber&quot;</span><span class="p">,</span> <span class="n">Page</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>

<span class="k">val</span> <span class="py">pageNumber</span><span class="p">:</span> <span class="n">Page</span> <span class="p">=</span> <span class="n">lens</span><span class="p">(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span> <span class="s">&quot;http://abc/search?pageNumber=55&quot;</span><span class="p">))</span>

<span class="k">val</span> <span class="py">updatedRequest</span><span class="p">:</span> <span class="n">Request</span> <span class="p">=</span> <span class="n">lens</span><span class="p">(</span><span class="n">pageNumber</span><span class="p">,</span> <span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span> <span class="s">&quot;http://abc/search&quot;</span><span class="p">))</span><span class="err">```</span>

<span class="n">In</span> <span class="p">[</span><span class="n">http4k</span><span class="p">],</span> <span class="n">Lenses</span> <span class="n">are</span> <span class="n">typically</span> <span class="n">used</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">typesafe</span> <span class="n">conversion</span> <span class="n">of</span> <span class="n">typed</span> <span class="n">values</span> <span class="n">into</span> <span class="n">and</span> <span class="k">out</span> <span class="n">of</span> <span class="n">HTTP</span> <span class="n">messages</span><span class="p">,</span> 
<span class="n">although</span> <span class="k">this</span> <span class="n">concept</span> <span class="n">has</span> <span class="n">been</span> <span class="n">extended</span> <span class="n">within</span> <span class="n">the</span> <span class="p">[</span><span class="n">http4k</span><span class="p">]</span> <span class="n">ecosystem</span> <span class="n">to</span> <span class="n">support</span> <span class="n">that</span> <span class="n">of</span> <span class="n">a</span> <span class="n">form</span> <span class="n">handling</span> <span class="n">and</span> <span class="n">request</span> 
<span class="n">contexts</span><span class="p">.</span>

<span class="err">##</span> <span class="n">http4k</span> <span class="n">Environments</span>
<span class="k">in</span> <span class="p">[</span><span class="n">http4k</span><span class="p">],</span> <span class="n">an</span> <span class="n">`Environment`</span> <span class="k">object</span> <span class="nc">is</span> <span class="n">a</span> <span class="n">context</span> <span class="n">which</span> <span class="n">holds</span> <span class="n">configuration</span> <span class="n">values</span><span class="p">.</span> <span class="n">It</span> <span class="n">effectively</span> <span class="n">behaves</span> <span class="n">like</span> <span class="n">a</span> 
<span class="n">`Map`</span><span class="p">,</span> <span class="k">in</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">composed</span> <span class="n">with</span> <span class="n">other</span> <span class="n">`Environment`</span> <span class="n">objects</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">a</span> <span class="n">consolidated</span> <span class="n">view</span> <span class="n">of</span> <span class="n">all</span> <span class="n">of</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span> 
<span class="n">component</span> <span class="n">values</span><span class="p">.</span> 

<span class="err">```</span><span class="n">kotlin</span>
<span class="k">package</span> <span class="nn">tutorials.typesafe_configuration.post</span>

<span class="k">import</span> <span class="nn">org.http4k.cloudnative.env.Environment</span>
<span class="k">import</span> <span class="nn">java.io.File</span>

<span class="k">val</span> <span class="py">systemEnv</span><span class="p">:</span> <span class="n">Environment</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ENV</span>
<span class="k">val</span> <span class="py">jvmFlags</span><span class="p">:</span> <span class="n">Environment</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">JVM_PROPERTIES</span>
<span class="k">val</span> <span class="py">jar</span><span class="p">:</span> <span class="n">Environment</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">fromResource</span><span class="p">(</span><span class="s">&quot;jar.properties&quot;</span><span class="p">)</span>
<span class="k">val</span> <span class="py">filesystem</span><span class="p">:</span> <span class="n">Environment</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="s">&quot;fs.properties&quot;</span><span class="p">))</span>
<span class="k">val</span> <span class="py">codeBased</span><span class="p">:</span> <span class="n">Environment</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="s">&quot;key1&quot;</span> <span class="n">to</span> <span class="s">&quot;value1&quot;</span><span class="p">,</span> <span class="s">&quot;key2&quot;</span> <span class="n">to</span> <span class="s">&quot;value2&quot;</span><span class="p">)</span>

<span class="k">val</span> <span class="py">consolidated</span><span class="p">:</span> <span class="n">Environment</span> <span class="p">=</span> <span class="n">jvmFlags</span> <span class="n">overrides</span> <span class="n">systemEnv</span> <span class="n">overrides</span> <span class="n">codeBased</span> <span class="n">overrides</span> <span class="n">filesystem</span> <span class="n">overrides</span> <span class="n">jar</span>
</code></pre></div>


<p>If you're using any of the other Kotlin-based configuration libraries, the above should look pretty familiar. The 
difference starts to become apparent when attempting to retrieve values from the <code>Environment</code> instance. This is done 
using <code>EnviromentKey</code> Lenses, which are an extension of the <a href="https://http4k.org">http4k</a> Lens system that specifically targets <code>Environment</code> 
objects. </p>
<p>```kotlin
package tutorials.typesafe_configuration.post</p>
<p>import org.http4k.cloudnative.env.Environment
import org.http4k.cloudnative.env.EnvironmentKey
import org.http4k.lens.Lens
import org.http4k.lens.duration
import org.http4k.lens.int
import java.time.Duration</p>
<p>data class Timeout(val value: Duration)
data class Port(val value: Int)
data class Host(val value: String)</p>
<p>// export TIMEOUT=PT30S
// export PORT=8080
// export HOSTNAMES=eu-west1.aws.com,eu-west2.aws.com,eu-west3.aws.com</p>
<p>val env = Environment.ENV</p>
<p>val portLens: Lens<Environment, Port> = EnvironmentKey.int().map(::Port).defaulted("PORT", Port(9000))
val timeoutLens: Lens<Environment, Timeout?> = EnvironmentKey.duration().map(::Timeout).optional("TIMEOUT")
val hostsLens: Lens<Environment, List\<Host>> = EnvironmentKey.map(::Host).multi.required("HOSTNAMES")</p>
<p>val timeout: Timeout? = timeoutLens(env)
val port: Port = portLens(env)
val hosts: List<Host> = hostsLens(env)```</p>
<h5 id="handling-failure">Handling failure</h5>
<p>When using the <a href="https://http4k.org">http4k</a> Environment to define config, missing or values which cannot be deserialised all now cause 
a <code>LensFailure</code> to be thrown with a descriptive error message. As before, this results in the application failing to 
start, but as the exception if both consistent and explicit, diagnosing the problem becomes much simpler.</p>
<h4 id="single-shot-secrets">Single-shot Secrets</h4>
<p>In order to avoid the accidental exposure of sensitive information such as passwords into the application runtime, a new 
type <code>Secret</code> has been introduced, which tries as much as possible to avoid exposing it's internal value as a readable 
<code>String</code>. The <code>Secret</code> class is designed to only have the string version of it's value read once, and only within a 
specific <code>use()</code> block, after which the underlying value is internally overwritten and further attempts to read it throw 
an <code>IllegalStateException</code>. </p>
<p>The typical use-case for this block is to set-up a SQL <code>Datasource</code> or to create a <code>Filter</code> which adds authentication to 
all outbound requests, as in the example below:</p>
<p>```kotlin
package tutorials.typesafe_configuration.post</p>
<p>import org.http4k.client.OkHttp
import org.http4k.cloudnative.env.Environment
import org.http4k.cloudnative.env.EnvironmentKey
import org.http4k.cloudnative.env.Secret
import org.http4k.core.Filter
import org.http4k.core.HttpHandler
import org.http4k.core.then
import org.http4k.filter.ServerFilters
import org.http4k.lens.Lens
import org.http4k.lens.secret</p>
<p>// export USER_PASSWORD=12345
val accessToken: Lens<Environment, Secret> = EnvironmentKey.secret().required("USER_PASSWORD")</p>
<p>val secret: Secret = accessToken(Environment.ENV)</p>
<p>val authFilter: Filter = secret.use { value: String -&gt; ServerFilters.BearerAuth(value) }</p>
<p>val authedHttp: HttpHandler = authFilter.then(OkHttp())```</p>
<p>As with other supported primitives, <code>Secret</code> is available by default in all supported Lens Locations.</p>
                    
                    
                    
                    
                    
                    


                    
                </article>
            </div>
        </div>
    </main>
    
    
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 - David Denton (@daviddenton), IvanSanchez (@s4nchez)
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
    
</div>

      <script src="../../assets/javascripts/application.583bbe55.js"></script>

<script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>




<script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-125143867-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>


</body>
</html>